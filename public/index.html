<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Nexa – Book an Appointment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#004aad; --bg:#f7f8fa; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
    .container{max-width:900px;margin:24px auto;padding:0 16px 120px}
    h1{margin:8px 0 20px;text-align:center}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px;display:inline-block}
    .input, select, .btn{width:100%;padding:12px;border-radius:10px;border:1px solid #cbd5e1;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{background:var(--brand);color:#fff;border:none;cursor:pointer;font-weight:600}
    .btn:hover{filter:brightness(.95)}
    .note{color:var(--muted);font-size:13px;margin-top:6px}
    .mt-2{margin-top:10px} .mt-3{margin-top:16px}
    .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;margin:2px}
    .pill-confirmed{background:#fee2e2;color:#991b1b} /* red-ish */
    .pill-pending{background:#f1f5f9;color:#475569}   /* gray */
    @media (max-width:640px){ .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Nexa – Book an Appointment</h1>
    <div class="card">
      <h2 style="margin:0 0 12px">Quick Lead Form</h2>

      <label class="label" for="name">Name</label>
      <input id="name" class="input" placeholder="Name" />

      <div class="mt-2"></div>
      <label class="label" for="phone">Phone</label>
      <input id="phone" class="input" placeholder="Phone" />

      <div class="mt-2"></div>
      <label class="label" for="service">Service</label>
      <input id="service" class="input" placeholder="Service" />

      <div class="mt-2"></div>
      <div class="row">
        <div>
          <label class="label" for="date">Date</label>
          <input id="date" type="date" class="input" />
        </div>
        <div>
          <label class="label" for="time">Time</label>
          <select id="time"></select>
          <div id="takenList" class="note" style="min-height:18px;margin-top:6px;"></div>
        </div>
      </div>

      <div class="note mt-2">
        Confirmed bookings block the calendar. Pending requests are shown in gray but may still be available.
      </div>

      <div class="mt-3"></div>
      <button class="btn" id="submitLead" type="button">Submit</button>
      <p id="status" class="note mt-2"></p>
    </div>
  </div>

  <script>
    // ===== Config =====
    const NEXA_KEY = "89ee71c2b83c9f90e0ba7a9bfa98eead"; // must match server
    const TIME_STEP_MIN = 15;

    // ===== Helpers =====
    function toMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
    function pad2(n){ return (n<10?'0':'')+n; }
    function minutesToHHMM(min){ const h=Math.floor(min/60), m=min%60; return `${pad2(h)}:${pad2(m)}`; }

    function buildTimeOptions(open, close, confirmed=[], pending=[]) {
      const sel = document.getElementById('time');
      sel.innerHTML = "";
      const openM = toMinutes(open), closeM = toMinutes(close);
      for (let m = openM; m <= closeM; m += TIME_STEP_MIN) {
        const t = minutesToHHMM(m);
        const opt = document.createElement('option');
        opt.value = t;
        if (confirmed.includes(t)) {
          opt.disabled = true;
          opt.textContent = `${t} (confirmed)`;
        } else if (pending.includes(t)) {
          opt.textContent = `${t} (pending)`;
          opt.style.color = "#64748b"; // gray text
        } else {
          opt.textContent = t;
        }
        sel.appendChild(opt);
      }
      const firstFree = Array.from(sel.options).find(o => !o.disabled);
      if (firstFree) sel.value = firstFree.value;
    }

    function showTakenPills(confirmed, pending) {
      const box = document.getElementById('takenList');
      const pills = [];
      if (confirmed.length) {
        pills.push("Confirmed: " + confirmed.map(t => `<span class="pill pill-confirmed">${t}</span>`).join(" "));
      }
      if (pending.length) {
        pills.push("Pending: " + pending.map(t => `<span class="pill pill-pending">${t}</span>`).join(" "));
      }
      box.innerHTML = pills.join("<br/>");
    }

    async function fetchAvailability(dateStr){
      if (!dateStr) return;
      const res = await fetch(`/api/availability?date=${encodeURIComponent(dateStr)}`, {
        headers: { 'X-Nexa-Key': NEXA_KEY }
      });
      const data = await res.json();
      const open = data?.hours?.open || "09:00";
      const close = data?.hours?.close || "18:00";

      // new: confirmed vs pending arrays
      const confirmed = Array.isArray(data?.taken) ? data.taken : [];
      const pending   = Array.isArray(data?.pending) ? data.pending : [];

      buildTimeOptions(open, close, confirmed, pending);
      showTakenPills(confirmed, pending);
    }

    async function saveLead(){
      const status = document.getElementById('status');
      status.textContent = "";
      const body = {
        name: document.getElementById('name').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        service: document.getElementById('service').value.trim(),
        appointment_date: document.getElementById('date').value,
        appointment_time: document.getElementById('time').value
      };
      try{
        const res = await fetch('/api/lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Nexa-Key': NEXA_KEY },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Submit failed");
        status.textContent = data.message || "Saved. We’ll contact you to confirm.";
        fetchAvailability(body.appointment_date);
      }catch(err){
        status.textContent = "Error: " + (err.message || String(err));
      }
    }

    function setDefaultDateToday(){
      const d = document.getElementById('date');
      if (!d.value) {
        const today = new Date();
        d.value = today.toISOString().split("T")[0];
      }
    }

    document.getElementById('submitLead')?.addEventListener('click', saveLead);
    document.getElementById('date')?.addEventListener('change', (e)=> fetchAvailability(e.target.value));

    setDefaultDateToday();
    fetchAvailability(document.getElementById('date').value);
  </script>
</body>
</html>
