<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Nexa – Book an Appointment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#004aad; --bg:#f7f8fa; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0}
    .container{max-width:900px;margin:24px auto;padding:0 16px 120px}
    h1{margin:8px 0 20px;text-align:center}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px;display:inline-block}
    .input, select, .btn{width:100%;padding:12px;border-radius:10px;border:1px solid #cbd5e1;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{background:var(--brand);color:#fff;border:none;cursor:pointer;font-weight:600}
    .btn:hover{filter:brightness(.95)}
    .note{color:var(--muted);font-size:13px;margin-top:6px}
    .mt-2{margin-top:10px} .mt-3{margin-top:16px}
    .pill{display:inline-block;background:#eef2ff;color:#1e3a8a;border-radius:999px;padding:2px 8px;font-size:12px;margin:2px}
    @media (max-width:640px){ .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Nexa – Book an Appointment</h1>
    <div class="card">
      <h2 style="margin:0 0 12px">Quick Lead Form</h2>

      <label class="label" for="name">Name</label>
      <input id="name" class="input" placeholder="Name" />

      <div class="mt-2"></div>
      <label class="label" for="phone">Phone</label>
      <input id="phone" class="input" placeholder="Phone" />

      <div class="mt-2"></div>
      <label class="label" for="service">Service</label>
      <input id="service" class="input" placeholder="Service" />

      <div class="mt-2"></div>
      <div class="row">
        <div>
          <label class="label" for="date">Date</label>
          <input id="date" type="date" class="input" />
        </div>
        <div>
          <label class="label" for="time">Time (available only)</label>
          <select id="time"></select>
          <div id="takenList" class="note" style="min-height:18px;margin-top:6px;"></div>
        </div>
      </div>

      <div class="note mt-2">
        Only <b>confirmed</b> bookings block the calendar. If two people pick the same time, you’ll confirm one in the email.
      </div>

      <div class="mt-3"></div>
      <button class="btn" id="submitLead" type="button">Submit</button>
      <p id="status" class="note mt-2"></p>
    </div>
  </div>

  <script>
    // ===== Config =====
    const NEXA_KEY = "89ee71c2b83c9f90e0ba7a9bfa98eead"; // must match NEXA_SERVER_KEY on server
    const TIME_STEP_MIN = 15; // minutes per slot

    // ===== Helpers =====
    function toMinutes(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
    function pad2(n){ return (n<10?'0':'')+n; }
    function minutesToHHMM(min){ const h=Math.floor(min/60), m=min%60; return `${pad2(h)}:${pad2(m)}`; }

    function buildTimeOptions(open, close, taken=[]) {
      const sel = document.getElementById('time');
      sel.innerHTML = "";
      const openM = toMinutes(open), closeM = toMinutes(close);
      for (let m = openM; m <= closeM; m += TIME_STEP_MIN) {
        const t = minutesToHHMM(m);
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        if (taken.includes(t)) { opt.disabled = true; opt.textContent = `${t} (confirmed)`; }
        sel.appendChild(opt);
      }
      const firstFree = Array.from(sel.options).find(o => !o.disabled);
      if (firstFree) sel.value = firstFree.value;
    }

    function showTakenPills(taken) {
      const box = document.getElementById('takenList');
      if (!taken || !taken.length) { box.textContent = ""; return; }
      box.innerHTML = "Confirmed: " + taken.map(t => `<span class="pill">${t}</span>`).join(" ");
    }

    async function fetchAvailability(dateStr){
      if (!dateStr) return;
      const res = await fetch(`/api/availability?date=${encodeURIComponent(dateStr)}`, {
        headers: { 'X-Nexa-Key': NEXA_KEY }
      });
      const data = await res.json();
      const open = data?.hours?.open || "09:00";
      const close = data?.hours?.close || "18:00";
      const taken = Array.isArray(data?.taken) ? data.taken : [];
      buildTimeOptions(open, close, taken);
      showTakenPills(taken);
    }

    // ===== Form submission =====
    async function saveLead(){
      const status = document.getElementById('status');
      status.textContent = "";
      const body = {
        name: document.getElementById('name').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        service: document.getElementById('service').value.trim(),
        appointment_date: document.getElementById('date').value,
        appointment_time: document.getElementById('time').value
      };
      try{
        const res = await fetch('/api/lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-Nexa-Key': NEXA_KEY },
          body: JSON.stringify(body)
        });
        const raw = await res.text();
        let data; try{ data = JSON.parse(raw) } catch{ data = { detail: raw } }

        if (!res.ok) {
          if (res.status === 409) {
            const taken = Array.isArray(data?.taken) ? data.taken : [];
            await fetchAvailability(body.appointment_date);
            status.textContent = data.message || "That time is already confirmed. Please choose another.";
            return;
          }
          const msg = Array.isArray(data?.detail)
            ? data.detail.map(d => d.msg).join('; ')
            : (data?.detail || data?.error || 'Submit failed');
          throw new Error(msg);
        }

        status.textContent = data.message || "Saved. We’ll contact you to confirm.";
        // Optionally clear fields:
        // ['name','phone','service'].forEach(id => document.getElementById(id).value = "");
      }catch(err){
        status.textContent = "Error: " + (err.message || String(err));
      }
    }

    // ===== Init =====
    function setDefaultDateToday(){
      const d = document.getElementById('date');
      if (!d.value) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = pad2(today.getMonth()+1);
        const dd = pad2(today.getDate());
        d.value = `${yyyy}-${mm}-${dd}`;
      }
    }

    document.getElementById('submitLead')?.addEventListener('click', saveLead);
    document.getElementById('date')?.addEventListener('change', (e)=> fetchAvailability(e.target.value));

    setDefaultDateToday();
    fetchAvailability(document.getElementById('date').value);
  </script>
</body>
</html>
